#!/bin/bash

export USE_BUFFER_NAME=send-to-$(basename $0).org
(
    if ! flock -n 9; then
        find-or-exec emacs "No such thing"
        emacsclient -e '(switch-to-buffer "'$USE_BUFFER_NAME'")'
        exit
    fi

    while true; do
        input=$(ask-for-input-with-emacs -p "What do you want say on $(basename $0)?" || true)
        if ! test "$input"; then
            exit
        fi
        (
            flock 10
            putclip-android "$input"&
            if test $(basename $0) = google+; then
                adb-long-press 144 374 # long press
                adb-tap 117 273 # paste
                adb-tap 949 935 # send
            elif test $(basename $0) = weibo; then
                adb input keyevent SPACE
                adb-long-press 440 281; adb-tap 545 191
                adb-tap 991 166
            elif test $(basename $0) = t1-sms; then
                adb-tap 560 1840 # 点空格
                adb-long-press 522 912 # 长按输入框
                adb-tap 480 802
                adb-tap 864 921
            elif test $(basename $0) = cell-mail; then
                adb shell input touchscreen swipe 586 878 586 268 500
                adb-tap 560 1840 #
                adb-long-press 322 283
                adb-tap 505 192
                adb-tap 998 174
            else # weixin and qq
                adb-tap 560 1840 # 点一下底部输入框，弹出软键盘
                sleep .1
                adb-tap 560 1840 # 再点一下，可能在出键盘，需要输入一个空格
                adb-long-press 560 976 # 长点输入框
                adb-tap 525 855 # 点一下粘贴钮
                adb-tap 976 976 # 点一下发送钮
            fi
        ) 10> ~/.logs/$(basename $0).lock-send &
    done
) 9> ~/.logs/$(basename $0).lock