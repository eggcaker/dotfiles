#!/usr/bin/env php
<?php

  /**
   *        name: gh-stock
   * description: query the stock information
   *       alias: [stock]; s=stock; hs="help stock"
   *      author: eggcaker <eggcaker@gmail.com>
   *     updated: 2013-07-10
   */

error_reporting(E_ERROR);

$stocks = array(
     '002116'=>array('price'=>14.432,'amount'=>9000),
//     '600816'=>array('price'=>22.428,'amount'=>7000),
     '600595' => array('price' => 6.502, 'amount' => 25100),
    );


function getSubstrings($text, $sopener, $scloser)
{
    $result = array();
    $noresult = substr_count($text, $sopener);
    $ncresult = substr_count($text, $scloser);

    if ($noresult < $ncresult) $nresult = $noresult;
    else $nresult = $ncresult;
    unset($noresult);
    unset($ncresult);

    for ($i = 0;$i < $nresult;$i++)
    {
        $pos = strpos($text, $sopener) + strlen($sopener);
        $text = substr($text, $pos, strlen($text));
        $pos = strpos($text, $scloser);
        $result[] = substr($text, 0, $pos);
        $text = substr($text, $pos + strlen($scloser) , strlen($text));
    }

    return $result;
}

function getStockData($code)
{
    global $stocks;

    $url = "http://hq.sinajs.cn/list=" . $code;
    $html = file_get_contents($url);
    $html = iconv('GBK', 'UTF-8', $html);
    $result = getSubstrings($html,'"','"');
    $data = explode(',',$result[0]);
    $ncode= substr($code,2,strlen($code));
    $p  = floor( ($data[3]-$data[2])*100*100/$data[2])/100;
    if ($p > 0)
        $p = "\033[31m +$p%\033[0m";
    else if ($p == 0)
        $p = "\033[37m $p%\033[0m";
    else if ($p < 0)
        $p = "\033[32m $p%\033[0m";
    $myprice_data = '';

    if (array_key_exists($ncode,$stocks))
    {
        $myprice = $stocks[$ncode]['price'];
        $p2 = floor( ($data[3] - $myprice  )*100*100/$myprice)/100;
        $p2 .= '%';
        $p3 = (int)($stocks[$ncode]['amount'] * ($data[3] - $myprice ));
        $p4 = (int)($data[3] * $stocks[$ncode]['amount']);
        $p5 = $stocks[$ncode]['amount'];
        $myprice_data = "我的成本  $p5 $myprice $p2 $p3(元) $p4(元)";

    }

    $return  =<<<EOINFO

 {$data[0]}
 当前走势  {$data[3]} $p
 $myprice_data
 昨日收盘  {$data[2]}   今日最高  $data[4]
 今日开盘  $data[1]   今日最低  $data[5]


EOINFO;

    if($code != 'sh000001')
    {
        $return .=" 五档盘口\n\n";
        $return .= " 卖5\t".(int)($data[28]/100)."\t" .$data[29]."\n";
        $return .= " 卖4\t".(int)($data[26]/100)."\t" .$data[27]."\n";
        $return .= " 卖3\t".(int)($data[24]/100)."\t" .$data[25]."\n";
        $return .= " 卖2\t".(int)($data[22]/100)."\t" .$data[23]."\n";
        $return .= " 卖1\t".(int)($data[20]/100)."\t" .$data[21]."\n\n";

        $return .= " 买1\t".(int)($data[10]/100)."\t" .$data[11]."\n";
        $return .= " 买2\t".(int)($data[12]/100)."\t" .$data[13]."\n";
        $return .= " 买3\t".(int)($data[14]/100)."\t" .$data[15]."\n";
        $return .= " 买4\t".(int)($data[16]/100)."\t" .$data[17]."\n";
        $return .= " 买5\t".(int)($data[18]/100)."\t" .$data[19]."\n\n";
    }
    return $return;
}

if (isset($argv[1])) {
    $code = "";
    switch (strlen(($argv[1]))) {
        case 8:
            $code = $argv[1];
            break;
        case 6:
            if ( substr($argv[1],0,1)  == "0" || substr($argv[1], 0,1) == "3" || substr($argv[1],0,1) == "1")
                $code = "sz";
            else
                $code = "sh";

            $code .= $argv[1];

            break;
        case 4:
            $code = $argv[1].substr(0,1) == "0" ? "sz00" : "sh60";
            $code .= $argv[1];
            break;

        case 3:
        case 2:
            $keys = array_keys($stocks);

            for ($i = 0; $i< count($keys);$i++) {
                if (strrpos($keys[$i], $argv[1]) > 0)
                    $code = $keys[$i];
            }


            if (substr($code,0,1) == "0" || substr($code,0,1) == "3")
                $code = "sz".$code;
            else if(substr($code, 0,1) == "6")
                $code = "sh".$code;

            break;
    }

    echo getStockData($code);

} else {
    echo getStockData("sh000001");
}
