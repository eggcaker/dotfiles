#!/usr/bin/env node

/**
 *        name: zi-search
 *  description: search stuff from network
 *       alias: [search]; se=search; sw="search weather"; sl="search lottery"
 *      author: eggcaker <eggcaker@gmail.com>
 *      updated: 2013-07-10
**/

var debug = require('debug')('zi-search');
var util = require('util');
var nodegrass = require('nodegrass');
var Table = require('cli-table');
var req = require('request');
var css = require('term-css');
var fs = require('fs');
var style = fs.readFileSync(__dirname + '/config/style.css', 'utf8');
var osmosis = require('osmosis');

var searcher = require('commander');

searcher.parse(process.argv);

//searcher.args.splice(0,1);
var keywords = searcher.args;

if (keywords.length) {
    switch(keywords[0]) {
        case "weather":
        searcher.args.splice(0,1);
        get_weather_info(keywords);
        break;
        case "lottery":
        get_lottery_info(keywords);
        break;
    }
} else {
    searcher.help();
}

function get_lottery_info(lt) {
    var tmp = 50;
    if (lt.length && lt[0] == '3d')
      tmp = 1;

    var url = 'http://hao123.lecai.com/lottery/ajax_lottery_draw_phaselist.php?lottery_type=' + tmp;


    var headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:24.0) Gecko/20100101 Firefox/24.0',
        'Content-Type' : 'application/x-www-form-urlencoded'
    };

    req.get({ url: url, form: null, headers: headers }, function (e, r, body) {
        var d = JSON.parse(body);
        var result = new Table( { colWidths: [10, 35],
                                  chars: { 'top': '' , 'top-mid': '' , 'top-left': '' , 'top-right': ''
                                , 'bottom': '' , 'bottom-mid': '' , 'bottom-left': '' , 'bottom-right': ''
                                , 'left': '║' , 'left-mid': '║' , 'mid': '-' , 'mid-mid': '-'
                                , 'right': '' , 'right-mid': '' , 'middle': '' }
                                });

        var red = d.data.data[0].result.result[0].data.toString();
        var blue = d.data.data[0].result.result[1].data.toString();

        var codes= {
          red: red,
          blue: blue,
        };


        var fn = css.compile('{red}  ---  {blue}', style);
        var css_code = fn(codes);


        result.push({'种类': tmp === 50 ? '双色球': '3D'});
        result.push({'期数': d.data.data[0].phase});
        result.push({'日期': d.data.data[0].time_endsale});
        result.push({'号码': css_code});

        console.log('');
        console.log('║----------------------------------------------');
        console.log(result.toString());
        console.log('║----------------------------------------------');
        console.log('');

    });
}

function get_weather_info(options) {

    if (options.length === 0 || options[0] === 'weather') {
        //get weather by default
        var url ='http://www.weather.com.cn/data/sk/101010100.html'
        nodegrass.get(url,function(data,status,headers){
        var result = new Table( { colWidths: [10, 20],
                                  chars: { 'top': '' , 'top-mid': '' , 'top-left': '' , 'top-right': ''
                                , 'bottom': '' , 'bottom-mid': '' , 'bottom-left': '' , 'bottom-right': ''
                                , 'left': '║' , 'left-mid': '║' , 'mid': '-' , 'mid-mid': '-'
                                , 'right': '' , 'right-mid': '' , 'middle': '' }
                                });

            var w = JSON.parse(data).weatherinfo;

            result.push({"城市": w.city});
            result.push({"温度": w.temp});
            result.push({"风向": w.WD});
            result.push({"风力": w.WS});
            result.push({"湿度": w.SD});
            result.push({"时间": w.time});
            console.log('');
            console.log('║-------------------------------');
            console.log(result.toString());
            console.log('║-------------------------------');
            console.log('');
        });

    } else if (options[0] === 'pm') {
        //get pm 2.5

      var pm_url = 'http://zx.bjmemc.com.cn/web/index.aspx';
      osmosis
        .get(pm_url)
        .find('h1')
        .set('pm2.5')
        .data(function(data) {
          console.log(data);
        });

    }
}
