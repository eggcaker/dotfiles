#!/bin/bash


LOCAL_REPO="$HOME/src/personal/share-photos"
REMOTE_REPO="https://share-pics.googlecode.com/git"


function moveImage {
  filename="`uuid`.png"
  d="`date +'%Y-%m-%d %H:%M:00'`"
  mv /tmp/shot.png $LOCAL_REPO/`date +'%Y'`/$filename
  echo "    $filename: $d" >> $LOCAL_REPO/history.yml
  cd $LOCAL_REPO
  git add .
  git ci -m "added picture $filename at $d" -a
  git push origin master
  longURL="$REMOTE_REPO/`date +'%Y'`/$filename"
  shortUrl $longURL |grep 'id": '|awk -F\" '{print $4}'  | xsel 
  #xclip -selection c
  rr="`xsel`"
  gnome-open "$rr"
  notify-send "DONE!!!!"
}

function shortUrl() {
  APIKEY="AIzaSyB_cbRRC1EKGEgYcHbzkOU4qy7UzhGYn8k"
  url="$1"
  curl -s https://www.googleapis.com/urlshortener/v1/url?key=$APIKEY  \
    -H 'Content-Type: application/json' \
    -d '{"longUrl": "'$url'"}'
}





if [[ "$1" == "url" ]]; then 
  echo "$REMOTE_REPO/`date +'%Y'`/`tail -n 1 $LOCAL_REPO/history.yml |awk -F: '{print $1}'|sed -e 's/ //g'`"|xclip -selection c
else 
  scrot -s /tmp/shot.png
  moveImage
fi
